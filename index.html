<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <style>
        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        /* Fixed header bar with logo, title, and control buttons. */
        #app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 1200;
            padding: 0 20px;
            box-sizing: border-box;
            font-weight: 700;
        }
        #app-header .header-inner { display:flex; align-items:center; width:100%; }
        #app-header .header-left { display:flex; align-items:center; }
        #app-header #header-logo { height:40px; margin-right:16px; }
        #app-header .header-center { flex:1 1 auto; text-align:left; }
        #app-header .header-center h1 { margin:0; font-size:18px; font-weight:700; color:#fff; }
        #app-header .header-center .version { font-size:11px; margin-left:8px; color:#aaa; font-weight:500; background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:12px; }
        #app-header .header-right { display:flex; gap:4px; align-items:center; }
        #app-header .hd-btn { background:transparent; border:none; font-size:16px; cursor:pointer; padding:8px; border-radius:4px; color:inherit; }
        #app-header .hd-btn:hover { background:rgba(255,255,255,0.06); }
        #app-header .hd-btn i { color:inherit; }

        /* Map container that fills the space below the header. */
        #map {
            position: absolute;
            top: 64px;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: calc(100% - 64px);
        }
        /* Popup layout using flexbox to allow embedded media to expand vertically while keeping links at bottom. */
        .leaflet-popup-content {
            display: flex;
            flex-direction: column;
            min-width: 620px;
            /* let Leaflet's popup option `maxHeight` control overall height */
            max-height: none;
        }
        .popup-body {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        .popup-table {
            flex: 0 0 auto;
            width: 100%;
            overflow: auto;
        }
        #pdf_container {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-end;
            width: 100%;
        }
        .leaflet-popup-content .media {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .leaflet-popup-content .media iframe,
        .leaflet-popup-content .media video,
        .leaflet-popup-content .media audio {
            border: none;
            flex: 1 1 auto;
            min-width: 600px;
            min-height: 600px;
            width: 600px;
            height: 600px;
            max-width: 90vw;
            max-height: 90vh;
        }
        .leaflet-popup-content .media a {
            margin-top: 0.5rem;
            align-self: flex-end;
        }
        /* Floating popup panels for legend, basemap selection, and add data controls. */
        .popup-pane {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 320px;
            max-height: 500px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.25);
            z-index: 1001;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .popup-pane.active {
            display: flex;
        }
        .popup-pane-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 14px;
            background: #f9f9f9;
        }
        .popup-pane-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            font-size: 13px;
        }
        /* Loading spinner animation for shapefile upload. */
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1a1a1a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Status message styling for upload feedback. */
        .upload-status {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .upload-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .upload-status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        </style>
        <title>City Wide Models</title>
    </head>
    <body>
        <header id="app-header">
            <div class="header-inner">
                <div class="header-left">
                    <img id="header-logo" src="https://www.arcgis.com/sharing/rest/content/items/a2fbbf6f3289475c8dddeddfca84395c/resources/images/widget_101/1767829219668.png?token=3NKHt6i2urmWtqOuugvr9bd8WzjqKdSdwMomqG6pEiMe8qWlQMRis6Ga38SyhsiX5QgBePLgLN-sjjiRZ4faEi7WrHmoy0DtQUYYHsU6G9V85OeosQHYolZcpAa29Y2w8mHHfRs5m7I3xklGCtKLFAsgrZKfue3KcVWqY3X5LqCteb1CAjur6ibl2W4PQZ9PvoxiPej5AFNX58s7sACDaQ_MT0tA5_dLMj6ek2hz7KYT-NiYk7l7GY0jF5kzmmXe" alt="logo">
                </div>
                <div class="header-center">
                     <!--<h1>UAE CITY WIDE MODELS <span class="version">v1.0</span></h1>-->
                     <h1>UAE CITY WIDE MODELS</h1>
                </div>
                <div class="header-right">
                    <button id="btn-basemap" class="hd-btn" title="Basemap"><i class="fas fa-th-large"></i></button>
                    <button id="btn-add" class="hd-btn" title="Add Data"><i class="fas fa-plus"></i></button>
                    <button id="btn-legend" class="hd-btn" title="Legend"><i class="fas fa-list"></i></button>
                    <button id="btn-layers" class="hd-btn" title="Map Layers"><i class="fas fa-layer-group"></i></button>
                </div>
            </div>
        </header>
        <div id="map"></div>
        <!-- Basemap Popup Pane -->
        <div id="basemap-popup" class="popup-pane">
            <div class="popup-pane-header">Basemap</div>
            <div class="popup-pane-content" id="basemap-content">
                <!-- Basemap options will be populated here -->
            </div>
        </div>
        <!-- Add Data Popup Pane -->
        <div id="add-data-popup" class="popup-pane">
            <div class="popup-pane-header">Add Data</div>
            <div class="popup-pane-content" id="add-data-content">
                <p style="text-align: center; color: #999; margin: 16px 0;">[WORK IN PROGRESS NOT YET WORKING] There is currently no added data.</p>
                <button id="btn-add-data-trigger" style="background: #1a1a1a; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; width: 100%; box-sizing: border-box;">+ Click to add data</button>
            </div>
        </div>
        <!-- Legend Popup Pane (Custom) -->
        <div id="legend-popup" class="popup-pane">
            <div class="popup-pane-header">Legend</div>
            <div class="popup-pane-content" id="legend-content">
                <!-- Layer items will be populated here -->
            </div>
        </div>
        <!-- Hidden file input for shapefile upload -->
        <input type="file" id="shp-file-input" multiple accept=".shp,.dbf,.shx,.prj" style="display: none;" />
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/shpjs@latest/dist/shp.min.js"></script>
        <script src="data/SiteLocations_1.js"></script>
        <script>
        var highlightLayer;
        /* Array to track dynamically added layers for legend and management. */
        var dynamicLayers = [];
        var dynamicLayerCounter = 0;
        
        /* Handle shapefile upload by triggering file input dialog. */
        function handleFileUpload() {
            document.getElementById('shp-file-input').click();
        }
        
        /* Process selected shapefile and convert to GeoJSON for map display. */
        document.getElementById('shp-file-input').addEventListener('change', function(e) {
            var files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            var addDataContent = document.getElementById('add-data-content');
            addDataContent.innerHTML = '<div class="upload-status loading"><span class="loading-spinner"></span> Processing shapefile...</div>';
            
            // Group files by base name (shp, dbf, shx, prj)
            var fileGroups = {};
            files.forEach(function(file) {
                var baseName = file.name.substring(0, file.name.lastIndexOf('.'));
                if (!fileGroups[baseName]) fileGroups[baseName] = {};
                var ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
                fileGroups[baseName][ext] = file;
            });
            
            // Process first valid shapefile group
            var processed = false;
            for (var baseName in fileGroups) {
                var group = fileGroups[baseName];
                if (group['.shp'] && group['.dbf']) {
                    processShapefileGroup(group, baseName, addDataContent);
                    processed = true;
                    break;
                }
            }
            
            if (!processed) {
                addDataContent.innerHTML = '<div class="upload-status error">Error: Must include both .shp and .dbf files</div><button id="btn-add-data-trigger" style="background: #1a1a1a; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; width: 100%; box-sizing: border-box;">+ Click to add data</button>';
                document.getElementById('btn-add-data-trigger').addEventListener('click', handleFileUpload);
            }
            
            // Reset file input
            e.target.value = '';
        });
        
        /* Parse shapefile group and create GeoJSON layer. */
        function processShapefileGroup(group, baseName, statusElement) {
            Promise.all([
                group['.shp'].arrayBuffer(),
                group['.dbf'].arrayBuffer()
            ]).then(function(buffers) {
                try {
                    var shapefile = shp.combine([
                        shp.parseShp(buffers[0]),
                        shp.parseDbf(buffers[1])
                    ]);
                    
                    var geojson = shapefile.features;
                    
                    if (!geojson || geojson.length === 0) {
                        console.error('processShapefileGroup: No features found in shapefile');
                        statusElement.innerHTML = '<div class="upload-status error">Error: No features found in shapefile</div><button id="btn-add-data-trigger" style="background: #1a1a1a; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; width: 100%; box-sizing: border-box;">+ Click to add data</button>';
                        document.getElementById('btn-add-data-trigger').addEventListener('click', handleFileUpload);
                        return;
                    }
                    
                    createDynamicLayer(geojson, baseName, statusElement);
                } catch (error) {
                    console.error('processShapefileGroup error:', error);
                    statusElement.innerHTML = '<div class="upload-status error">Error: ' + error.message + '</div><button id="btn-add-data-trigger" style="background: #1a1a1a; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; width: 100%; box-sizing: border-box;">+ Click to add data</button>';
                    document.getElementById('btn-add-data-trigger').addEventListener('click', handleFileUpload);
                }
            }).catch(function(error) {
                console.error('processShapefileGroup file read error:', error);
                statusElement.innerHTML = '<div class="upload-status error">Error reading files: ' + error.message + '</div><button id="btn-add-data-trigger" style="background: #1a1a1a; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; width: 100%; box-sizing: border-box;">+ Click to add data</button>';
                document.getElementById('btn-add-data-trigger').addEventListener('click', handleFileUpload);
            });
        }
        
        /* Create and add dynamic layer with appropriate styling based on geometry type. */
        function createDynamicLayer(features, layerName, statusElement) {
            dynamicLayerCounter++;
            var layerId = 'dynamic_layer_' + dynamicLayerCounter;
            var paneId = 'pane_' + layerId;
            
            // Validate features exist
            if (!features || features.length === 0) {
                console.error('createDynamicLayer: No features to add');
                statusElement.innerHTML = '<div class="upload-status error">Error: No valid features found</div><button id="btn-add-data-trigger" style="background: #1a1a1a; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; width: 100%; box-sizing: border-box;">+ Click to add data</button>';
                document.getElementById('btn-add-data-trigger').addEventListener('click', handleFileUpload);
                return;
            }
            
            // Create pane for new layer with high z-index
            map.createPane(paneId);
            map.getPane(paneId).style.zIndex = 406 + dynamicLayerCounter;
            
            try {
                // Create GeoJSON layer with styling
                var geoJsonLayer = L.geoJSON({type: 'FeatureCollection', features: features}, {
                    pane: paneId,
                    style: function(feature) {
                        return getStyleForGeometry(feature.geometry.type);
                    },
                    pointToLayer: function(feature, latlng) {
                        return L.circleMarker(latlng, getStyleForGeometry('Point'));
                    },
                    onEachFeature: function(feature, layer) {
                        var popupContent = '<table style="font-size: 12px; width: 100%;">';
                        if (feature.properties) {
                            for (var key in feature.properties) {
                                var value = feature.properties[key];
                                popupContent += '<tr><th style="text-align: left; padding: 4px;">' + key + '</th><td style="padding: 4px;">' + (value !== null ? String(value) : '') + '</td></tr>';
                            }
                        }
                        popupContent += '</table>';
                        layer.bindPopup(popupContent);
                    }
                });
                
                // Verify layer has features
                var layerCount = 0;
                geoJsonLayer.eachLayer(function() { layerCount++; });
                if (layerCount === 0) {
                    console.error('createDynamicLayer: GeoJSON layer created but has no features after rendering');
                    statusElement.innerHTML = '<div class="upload-status error">Error: Layer created but has no renderable features</div><button id="btn-add-data-trigger" style="background: #1a1a1a; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; width: 100%; box-sizing: border-box;">+ Click to add data</button>';
                    document.getElementById('btn-add-data-trigger').addEventListener('click', handleFileUpload);
                    return;
                }
                

                
                map.addLayer(geoJsonLayer);
                
                // Track layer
                var layerObj = {
                    id: layerId,
                    name: layerName,
                    layer: geoJsonLayer,
                    paneId: paneId
                };
                dynamicLayers.push(layerObj);
                
                // Update Add Data popup with success message and option to add more
                statusElement.innerHTML = '<div class="upload-status success">✓ ' + layerName + ' (' + layerCount + ' features) added successfully</div><button id="btn-add-data-trigger" style="background: #1a1a1a; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; width: 100%; box-sizing: border-box;">+ Add more data</button>';
                document.getElementById('btn-add-data-trigger').addEventListener('click', handleFileUpload);
                
                // Update legend
                populateLegend();
                
                // Fit map to new layer bounds and refresh visible labels
                var bounds = geoJsonLayer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, {padding: [50, 50]});
                    // Refresh labels after fitBounds completes
                    setTimeout(function() {
                        updateVisibleLabels();
                    }, 300);
                }
            } catch (err) {
                console.error('createDynamicLayer error:', err);
                statusElement.innerHTML = '<div class="upload-status error">Error creating layer: ' + err.message + '</div><button id="btn-add-data-trigger" style="background: #1a1a1a; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; width: 100%; box-sizing: border-box;">+ Click to add data</button>';
                document.getElementById('btn-add-data-trigger').addEventListener('click', handleFileUpload);
            }
        }
        
        /* Return styling object based on geometry type. */
        function getStyleForGeometry(geometryType) {
            if (geometryType === 'Point' || geometryType === 'MultiPoint') {
                return {
                    radius: 6,
                    fillColor: '#4285F4',
                    color: '#1a73e8',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                };
            } else if (geometryType === 'LineString' || geometryType === 'MultiLineString') {
                return {
                    color: '#34A853',
                    weight: 3,
                    opacity: 0.8
                };
            } else if (geometryType === 'Polygon' || geometryType === 'MultiPolygon') {
                return {
                    fillColor: '#FBBC04',
                    color: '#F57C00',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.5
                };
            }
            return {color: '#999'};
        }
        
        /* Toggle popup pane visibility and close other open panes. */
        function togglePopup(paneId) {
            var pane = document.getElementById(paneId);
            var allPanes = document.querySelectorAll('.popup-pane');
            allPanes.forEach(function(p) {
                if (p.id !== paneId) p.classList.remove('active');
            });
            pane.classList.toggle('active');
        }
        
        /* Auto-close all popups when user clicks outside them. */
        document.addEventListener('click', function(event) {
            var panes = document.querySelectorAll('.popup-pane');
            var buttons = document.querySelectorAll('.hd-btn');
            var clickedPane = false;
            var clickedButton = false;
            
            panes.forEach(function(pane) {
                if (pane.contains(event.target)) clickedPane = true;
            });
            buttons.forEach(function(btn) {
                if (btn.contains(event.target)) clickedButton = true;
            });
            
            if (!clickedPane && !clickedButton) {
                panes.forEach(function(pane) {
                    pane.classList.remove('active');
                });
                var layersControl = document.querySelector('.leaflet-control-layers');
                if (layersControl) layersControl.style.display = 'none';
            }
        });
        
        /* Highlight features on hover by applying yellow color. */
        function highlightFeature(e) {
            highlightLayer = e.target;

            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
              highlightLayer.setStyle({
                color: 'rgba(255, 255, 0, 1.00)',
              });
            } else {
              highlightLayer.setStyle({
                fillColor: 'rgba(255, 255, 0, 1.00)',
                fillOpacity: 1
              });
            }
        }
        /* Initialize the Leaflet map with zoom controls and set geographic bounds. */
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:1
        }).fitBounds([[23.03929019943693,51.96385977183751],[25.782197414121743,57.28631471633466]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        /* Remove empty popup rows and detect media files (PDF, images, video, audio). */
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        /* Embed PDF, image, audio, and video content in popups with appropriate viewers/players. */
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            // handle images/audio/video already present in content
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() { popup.update(); }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() { popup.setContent(tempDiv.innerHTML); popup.update(); }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.maxHeight = "60vh";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    video.addEventListener('loadedmetadata', function() { popup.update(); });
                    setTimeout(function() { popup.setContent(tempDiv.innerHTML); popup.update(); }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            }


            // if we reach here and no media found, ensure class is removed
            if (!tempDiv.querySelector('.media')) {
                popup._contentNode.classList.remove('media');
            }
        }
        /* Add zoom and measurement controls to the map. */
        var title = new L.Control({'position':'topright'});
        title.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };
        title.update = function () {
            this._div.innerHTML = '<h2>City Wide Models</h2>';
        };
        // Title is shown in the fixed header above; do not add Leaflet map control title to avoid duplication
        // title.addTo(map);
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';
        /* Add scale bar to show distance reference on the map. */
        L.control.scale({position: 'bottomleft', metric: true, imperial: false}).addTo(map);
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
        /* Create basemap tile layer panes with proper z-index ordering. */
        map.createPane('pane_ESRISatellite_0');
        map.getPane('pane_ESRISatellite_0').style.zIndex = 400;
        var layer_ESRISatellite_0 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            pane: 'pane_ESRISatellite_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 20
        });
        layer_ESRISatellite_0;
        map.addLayer(layer_ESRISatellite_0);
        /* Create popup content and event handlers for Site Location point features. */
        function pop_SiteLocations_1(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<div class="popup-body"><div class="popup-table"><table>\
                    <tr>\
                        <th scope="row">Location_C</th>\
                        <td>' + (feature.properties['Location_C'] !== null ? autolinker.link(String(feature.properties['Location_C']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">x_coord</th>\
                        <td>' + (feature.properties['x_coord'] !== null ? autolinker.link(String(feature.properties['x_coord']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">y_coord</th>\
                        <td>' + (feature.properties['y_coord'] !== null ? autolinker.link(String(feature.properties['y_coord']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">DateAdded</th>\
                        <td>' + (feature.properties['DateAdded'] !== null ? autolinker.link(String(feature.properties['DateAdded']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">AddedBy</th>\
                        <td>' + (feature.properties['AddedBy'] !== null ? autolinker.link(String(feature.properties['AddedBy']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Document_T</th>\
                        <td>' + (feature.properties['Document_T'] !== null ? autolinker.link(String(feature.properties['Document_T']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Document_P</th>\
                        <td>' + (feature.properties['Document_P'] !== null ? autolinker.link(String(feature.properties['Document_P']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">DateAdded_</th>\
                        <td>' + (feature.properties['DateAdded_'] !== null ? autolinker.link(String(feature.properties['DateAdded_']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">AddedBy_1</th>\
                        <td>' + (feature.properties['AddedBy_1'] !== null ? autolinker.link(String(feature.properties['AddedBy_1']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">EPSG4326_x</th>\
                        <td>' + (feature.properties['EPSG4326_x'] !== null ? autolinker.link(String(feature.properties['EPSG4326_x']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">EPSG4326_y</th>\
                        <td>' + (feature.properties['EPSG4326_y'] !== null ? autolinker.link(String(feature.properties['EPSG4326_y']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table></div>\
                <div id="pdf_container"></div></div>';
                var popupHeader = '<div style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: #fff; padding: 12px 16px; margin: -8px -8px 12px -8px; border-radius: 4px 4px 0 0;"><div style="font-size: 14px; font-weight: 700; color: #ff3333;">' + (feature.properties['Location_C'] || 'Location') + '</div><div style="font-size: 11px; color: #ccc; margin-top: 2px;">Point Location Detail</div></div>';
                var popupContent_styled = '<div style="font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', sans-serif; font-size: 12px; color: #1a1a1a;"><style>.popup-detail-row { display: flex; padding: 8px 0; border-bottom: 1px solid #f0f0f0; } .popup-detail-row:last-child { border-bottom: none; } .popup-detail-label { font-weight: 600; color: #1a1a1a; width: 100px; min-width: 100px; color: #cc0000; } .popup-detail-value { color: #333; flex: 1; word-break: break-word; }</style><div style="padding: 8px 0;">' + popupContent.replace(/<table[^>]*>/g, '').replace(/<\/table>/g, '').replace(/<tr>/g, '<div class="popup-detail-row">').replace(/<\/tr>/g, '</div>').replace(/<th[^>]*>/g, '<div class="popup-detail-label">').replace(/<\/th>/g, '</div>').replace(/<td[^>]*>/g, '<div class="popup-detail-value">').replace(/<\/td>/g, '</div>') + '</div></div>';
                var fullPopupContent = popupHeader + popupContent_styled + '<div id="pdf_container"></div>';
                var content = removeEmptyRowsFromPopupContent(fullPopupContent, feature);
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 800 });
        }

        /* Define color, size, and opacity styling for Site Location markers. */
        function style_SiteLocations_1_0() {
            return {
                pane: 'pane_SiteLocations_1',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(45,45,45,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(255,0,0,1.0)',
                interactive: true,
            }
        }
        /* Create pane for Site Locations and set high z-index to keep points on top of basemaps. */
        map.createPane('pane_SiteLocations_1');
        map.getPane('pane_SiteLocations_1').style.zIndex = 405;
        map.getPane('pane_SiteLocations_1').style['mix-blend-mode'] = 'normal';
        var layer_SiteLocations_1 = new L.geoJson(json_SiteLocations_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_SiteLocations_1',
            layerName: 'layer_SiteLocations_1',
            pane: 'pane_SiteLocations_1',
            onEachFeature: pop_SiteLocations_1,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_SiteLocations_1_0(feature));
            },
        });
        bounds_group.addLayer(layer_SiteLocations_1);
        map.addLayer(layer_SiteLocations_1);
        /* Define additional basemap options (ESRI Street, OSM, Google Hybrid, Google Labels). */
        map.createPane('pane_ESRIStandard_0');
        map.getPane('pane_ESRIStandard_0').style.zIndex = 400;
        var layer_ESRIStandard_0 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
            pane: 'pane_ESRIStandard_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 20
        });
        map.createPane('pane_OSMStandard_1');
        map.getPane('pane_OSMStandard_1').style.zIndex = 401;
        var layer_OSMStandard_1 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OSMStandard_1',
            opacity: 1.0,
            attribution: '<a href="https://www.openstreetmap.org/copyright">© OpenStreetMap contributors, CC-BY-SA</a>',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        map.createPane('pane_GoogleHybrid_2');
        map.getPane('pane_GoogleHybrid_2').style.zIndex = 402;
        var layer_GoogleHybrid_2 = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleHybrid_2',
            opacity: 1.0,
            attribution: '<a href="https://www.google.at/permissions/geoguidelines/attr-guide.html">Map data © Google</a>',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 20
        });
        map.createPane('pane_GoogleLabels_4');
        map.getPane('pane_GoogleLabels_4').style.zIndex = 404;
        var layer_GoogleLabels_4 = L.tileLayer('https://mt1.google.com/vt/lyrs=h&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleLabels_4',
            opacity: 1.0,
            attribution: '<a href="https://www.google.at/permissions/geoguidelines/attr-guide.html">Map data © Google</a>',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 20
        });
        map.addLayer(layer_GoogleLabels_4);

        /* Define all layers available in the legend with basemap radio groups and overlay toggles. */
        var overlaysTree = [
            {label: '<img src="legend/SiteLocations_1.png" /> Location Codes', layer: layer_SiteLocations_1},
            {label: "Google Labels", layer: layer_GoogleLabels_4},
            {label: "ESRI Satellite", layer: layer_ESRISatellite_0, radioGroup: 'bm' },
            {label: "Google Hybrid", layer: layer_GoogleHybrid_2, radioGroup: 'bm' },
            {label: "OSM Standard", layer: layer_OSMStandard_1, radioGroup: 'bm' },
            {label: "ESRI Standard", layer: layer_ESRIStandard_0, radioGroup: 'bm' },]
        var lay = L.control.layers.tree(null, overlaysTree,{
            collapsed: true,
        });
        /* Initialize layer tree control but hide it; custom legend popup will replace it. */
        lay.addTo(map);
        lay._container.style.display = 'none';

        /* Dynamically generate legend popup with checkboxes for controlling layer visibility. */
        function populateLegend() {
            var legendContent = document.getElementById('legend-content');
            legendContent.innerHTML = '';
            
            // Define which layers to show in the legend (overlays only, not basemaps)
            var legendLayers = [
                {name: 'Location Codes', layer: layer_SiteLocations_1, hasImage: true}
            ];
            
            // Add dynamic layers to legend
            dynamicLayers.forEach(function(dynLayer) {
                legendLayers.push({
                    name: dynLayer.name,
                    layer: dynLayer.layer,
                    isDynamic: true,
                    dynId: dynLayer.id
                });
            });
            
            legendLayers.forEach(function(item) {
                var div = document.createElement('div');
                div.style.padding = '8px 0';
                div.style.borderBottom = '1px solid #f0f0f0';
                
                var label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.cursor = 'pointer';
                label.style.gap = '8px';
                
                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = map.hasLayer(item.layer);
                checkbox.style.cursor = 'pointer';
                
                var span = document.createElement('span');
                span.style.fontSize = '13px';
                
                if (item.hasImage) {
                    var img = document.createElement('img');
                    img.src = 'legend/SiteLocations_1.png';
                    img.style.height = '20px';
                    img.style.marginRight = '4px';
                    span.appendChild(img);
                }
                
                span.appendChild(document.createTextNode(item.name));
                
                // Add delete button for dynamic layers
                if (item.isDynamic) {
                    var deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '×';
                    deleteBtn.style.background = 'transparent';
                    deleteBtn.style.border = 'none';
                    deleteBtn.style.color = '#999';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.style.fontSize = '18px';
                    deleteBtn.style.padding = '0 4px';
                    deleteBtn.style.marginLeft = 'auto';
                    deleteBtn.title = 'Remove layer';
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        removeDynamicLayer(item.dynId);
                    });
                    label.appendChild(deleteBtn);
                }
                
                label.appendChild(checkbox);
                label.appendChild(span);
                
                // Wire checkbox to toggle layer visibility
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(item.layer);
                    } else {
                        map.removeLayer(item.layer);
                    }
                });
                
                div.appendChild(label);
                legendContent.appendChild(div);
            });
        }
        
        /* Remove dynamic layer from map and legend. */
        function removeDynamicLayer(layerId) {
            for (var i = 0; i < dynamicLayers.length; i++) {
                if (dynamicLayers[i].id === layerId) {
                    map.removeLayer(dynamicLayers[i].layer);
                    if (map.getPane(dynamicLayers[i].paneId)) {
                        map.getPane(dynamicLayers[i].paneId).remove();
                    }
                    dynamicLayers.splice(i, 1);
                    populateLegend();
                    break;
                }
            }
        }
        
        /* Populate basemap selection popup with checkbox for Google Labels and radio buttons for exclusive basemap selection. */
        function populateBasemap() {
            var basemapContent = document.getElementById('basemap-content');
            if (!basemapContent) return;
            basemapContent.innerHTML = '';
            
            // Google Labels as checkbox (toggleable overlay)
            var googleLabelsDiv = document.createElement('div');
            googleLabelsDiv.style.padding = '8px 0';
            googleLabelsDiv.style.borderBottom = '1px solid #f0f0f0';
            
            var googleLabelsLabel = document.createElement('label');
            googleLabelsLabel.style.display = 'flex';
            googleLabelsLabel.style.alignItems = 'center';
            googleLabelsLabel.style.cursor = 'pointer';
            googleLabelsLabel.style.gap = '8px';
            
            var googleLabelsCheckbox = document.createElement('input');
            googleLabelsCheckbox.type = 'checkbox';
            googleLabelsCheckbox.checked = map.hasLayer(layer_GoogleLabels_4);
            googleLabelsCheckbox.style.cursor = 'pointer';
            
            var googleLabelsSpan = document.createElement('span');
            googleLabelsSpan.style.fontSize = '13px';
            googleLabelsSpan.appendChild(document.createTextNode('Google Labels'));
            
            googleLabelsLabel.appendChild(googleLabelsCheckbox);
            googleLabelsLabel.appendChild(googleLabelsSpan);
            
            googleLabelsCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(layer_GoogleLabels_4);
                } else {
                    map.removeLayer(layer_GoogleLabels_4);
                }
                populateBasemap(); // Update UI
            });
            
            googleLabelsDiv.appendChild(googleLabelsLabel);
            basemapContent.appendChild(googleLabelsDiv);
            
            // Basemap options with exclusive radio buttons
            var basemaps = [
                {name: 'ESRI Satellite', layer: layer_ESRISatellite_0},
                {name: 'Google Hybrid', layer: layer_GoogleHybrid_2},
                {name: 'OSM Standard', layer: layer_OSMStandard_1},
                {name: 'ESRI Standard', layer: layer_ESRIStandard_0}
            ];
            
            basemaps.forEach(function(item) {
                var div = document.createElement('div');
                div.style.padding = '8px 0';
                div.style.borderBottom = '1px solid #f0f0f0';
                
                var label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.cursor = 'pointer';
                label.style.gap = '8px';
                
                var radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'basemap-selection';
                radio.checked = map.hasLayer(item.layer);
                radio.style.cursor = 'pointer';
                
                var span = document.createElement('span');
                span.style.fontSize = '13px';
                span.appendChild(document.createTextNode(item.name));
                
                label.appendChild(radio);
                label.appendChild(span);
                
                // Wire radio button to switch basemaps exclusively
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        basemaps.forEach(function(bm) {
                            if (map.hasLayer(bm.layer)) {
                                map.removeLayer(bm.layer);
                            }
                        });
                        map.addLayer(item.layer);
                        populateBasemap(); // Update UI
                    }
                });
                
                div.appendChild(label);
                basemapContent.appendChild(div);
            });
        }
        
        /* Initialize legend and update whenever layers change on the map. */
        populateLegend();
        
        map.on('layeradd layerremove', populateLegend);

        /* Wire header buttons to toggle their respective popup panes. */
        document.getElementById('btn-legend').addEventListener('click', function(e) {
            e.stopPropagation();
            var allPanes = document.querySelectorAll('.popup-pane');
            allPanes.forEach(function(p) {
                if (p.id !== 'legend-popup') p.classList.remove('active');
            });
            var legendPane = document.getElementById('legend-popup');
            if (legendPane) {
                legendPane.classList.toggle('active');
                populateLegend();
            }
        });
        // Wire Basemap button
        document.getElementById('btn-basemap').addEventListener('click', function(e) {
            e.stopPropagation();
            var allPanes = document.querySelectorAll('.popup-pane');
            allPanes.forEach(function(p) {
                if (p.id !== 'basemap-popup') p.classList.remove('active');
            });
            var basemapPane = document.getElementById('basemap-popup');
            if (basemapPane) {
                basemapPane.classList.toggle('active');
                populateBasemap();
            }
        });
        // Wire Add Data button
        document.getElementById('btn-add').addEventListener('click', function(e) {
            e.stopPropagation();
            togglePopup('add-data-popup');
        });
        // Wire Add Data trigger button
        document.getElementById('btn-add-data-trigger').addEventListener('click', handleFileUpload);
        
        /* Debounce function to limit how often expensive operations run. */
        function debounce(func, wait) {
            var timeout;
            return function executedFunction(...args) {
                var later = function() {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        /* Wrapper for resetLabels with debouncing to prevent performance issues during zoom. */
        var debouncedResetLabels = debounce(function(layers) {
            resetLabels(layers);
        }, 300);
        
        setBounds();
        /* Bind tooltips (location code labels) to each Site Location feature with hover-only display. */
        var i = 0;
        layer_SiteLocations_1.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            // Use bindTooltip with permanent: true for constant display at building scale zoom levels (18-20)
            layer.bindTooltip((layer.feature.properties['Location_C'] !== null?String('<div style="color: #ffffff; font-size: 10pt; font-weight: bold; font-family: \'Open Sans\', sans-serif; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, -2px 0 0 #000, 2px 0 0 #000, 0 -2px 0 #000, 0 2px 0 #000;">' + layer.feature.properties['Location_C']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_SiteLocations_1'});
            i++;
        });
        /* Only open labels for features that are currently inside the map view and within zoom range.
           This prevents rendering labels for off-screen points and improves performance. */
        function updateVisibleLabels() {
            if (!map.hasLayer(layer_SiteLocations_1)) return;
            var bounds = map.getBounds();
            var zoom = map.getZoom();
            var minZoom = 16; // minimum zoom to show labels
            var maxZoom = 20; // maximum zoom to show labels

            layer_SiteLocations_1.eachLayer(function(layer) {
                try {
                    var inView = false;
                    if (typeof layer.getLatLng === 'function') {
                        var latlng = layer.getLatLng();
                        if (latlng) inView = bounds.contains(latlng);
                    } else if (typeof layer.getBounds === 'function') {
                        var lb = layer.getBounds();
                        if (lb && typeof lb.intersects === 'function') inView = bounds.intersects(lb);
                    }

                    if (zoom >= minZoom && zoom <= maxZoom && inView) {
                        layer.openTooltip();
                    } else {
                        layer.closeTooltip();
                    }
                } catch (err) {
                    // ignore any layers that don't support tooltip operations
                }
            });
        }

        var debouncedUpdateVisibleLabels = debounce(function() {
            updateVisibleLabels();
        }, 200);

        // Update labels after map movement, zoom changes, and when layers change
        map.on('moveend zoomend', debouncedUpdateVisibleLabels);
        map.on('layeradd layerremove', debouncedUpdateVisibleLabels);

        // Initial population
        debouncedUpdateVisibleLabels();
        </script>        
    </body>
</html>